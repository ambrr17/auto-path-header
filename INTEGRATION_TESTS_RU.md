# Сценарии интеграционных тестов (VS Code Extension)

Цель: проверить поведение расширения в среде VS Code (Extension Development Host) с реальными событиями редактора.

## 0. Подготовка окружения
- Установить тестовый воркспейс с несколькими файлами/папками и поддерживаемыми/неподдерживаемыми типами.
- Включить/выключать настройки расширения через `workspace.getConfiguration()` (или settings.json тестового воркспейса).

## 1. Активация расширения
1.1 Активация по onLanguage:
- Открыть пустой `test.ts` → расширение активируется (есть в “Developer: Show Running Extensions”).
- Открыть `test.txt` → не активируется автоматически.

1.2 Активация по onCommand:
- В `test.txt` выполнить команду `Auto Path Header: Insert Path Comment` → расширение активируется событием onCommand.

## 2. Автовставка комментария при открытии файла
2.1 Чистый новый файл (поддерживаемый язык):
- Создать/открыть пустой `test.ts` (0 строк → VS Code создаёт 1 пустую строку)
- Проверить: в начало добавлен комментарий `// <relativePath>` + пустая строка.

2.2 Файл с несколькими строками:
- Открыть `test.ts` с 2+ строками и без комментария в первой строке
- Проверить: автовставки нет (согласно условию `document.lineCount > 1`).

2.3 Файл неподдерживаемого языка:
- Открыть `test.txt` → автовставки нет.

2.4 Файл `Log` (languageId: Log):
- Открыть лог-файл → автовставки нет.

2.5 Неизвестная схема/Untitled:
- Открыть Untitled документ → автовставки нет.

## 3. Предотвращение дублирования
3.1 Уже есть корректный комментарий первой строкой:
- Открыть `test.ts` с первой строкой `// <relativePath>`
- Проверить: автовставки нет (дубликат не добавляется).

3.2 Комментарий с обратными слешами (Windows-путь):
- Первая строка `// src\example.ts`
- Проверить: дублирования нет (нормализация слешей).

## 4. Ручная команда вставки комментария
4.1 Пустая первая строка:
- В `test.ts` выполнить команду → комментарий вставлен.

4.2 Комментарий уже есть:
- В `test.ts` с существующим комментарием выполнить команду → сообщение/индикация, что комментарий уже существует; вставки нет.

4.3 Неподдерживаемый язык:
- В `test.txt` выполнить команду → предупреждение о неподдерживаемом языке.

## 5. Обновление комментария при переименовании/перемещении файла
5.1 updateOnRename=true, askBeforeUpdate=false:
- В `src/a/test.ts` есть первая строка `// src/a/test.ts`
- Переименовать в `src/b/test.ts`
- Проверить: первая строка стала `// src/b/test.ts` без запроса.

5.2 updateOnRename=true, askBeforeUpdate=true:
- Аналогично 5.1, но ожидать диалог подтверждения. При выборе “Yes” — обновить; при “No” — оставить как есть.

5.3 updateOnRename=false:
- Переименование не меняет первую строку.

5.4 Есть комментарий, но путь не совпадает с `oldPath`:
- Переименовать файл при первой строке `// другое значение`
- Проверить: обновления нет.

5.5 Изменение расширения файла/языка:
- Переименовать `src/a/test.ts` в `src/a/test.py`
- Проверить: первая строка меняется на `# src/a/test.py`.

5.6 Неподдерживаемый язык при переименовании:
- Переименовать `test.txt` с первой строкой `# src/a/test.txt`
- Проверить: обновления нет (или предупреждение, если предусмотрено сообщения).

## 6. Форматы комментариев по языкам
- Проверить корректную форму комментария:
  - JS/TS/Java/C/CPP/C#/Go/Rust/Swift/Kotlin/PHP → `// <path>`
  - Python/Shell/Ruby/Perl/Dotenv → `# <path>`
  - CSS/SCSS/SASS → `/* <path> */`
  - SQL → `-- <path>`
  - HTML/XML → `<!-- <path>-->`

## 7. Локализация сообщений
- При неподдерживаемом языке/ошибке редактирования:
  - Проверить текст сообщения на EN/RU при соответствующей локали окружения VS Code.

## 8. Настройки расширения
8.1 autoPathHeader.updateOnRename (true/false):
- Поведение из раздела 5 соответствует настройке.

8.2 autoPathHeader.askBeforeUpdate (true/false):
- Диалог подтверждения отображается/не отображается согласно настройке.

(Новое) 8.3 autoPathHeader.formatTemplate:
- Изменить шаблон, например `{prefix}[{path}]{suffix}` → комментарий принимает новый вид для всех языков.

(Новое) 8.4 autoPathHeader.disabledLanguages:
- Добавить `typescript` → при открытии и переименовании `.ts` файлы остаются без комментария/обновления.

(Примечание: настройка `autoPathHeader.enabled` не участвует в логике на текущий момент; покрыть при добавлении поддержки.)

## 9. Краевые случаи
- Файлы в глубоко вложенных папках: корректный относительный путь.
- Переименование с одновременным переносом между папками.
- Переименование, когда файл не открыт в редакторе: расширение открывает и корректно обновляет первую строку.
- Разные кодировки/концы строк: отсутствие краша, корректное редактирование.

---

Формат: интеграционные тесты запускать через VS Code Test Runner (`@vscode/test-electron`) со скриптом, создающим/изменяющим файлы в тестовом воркспейсе, выполняющим команды и проверяющим содержимое первой строки.
